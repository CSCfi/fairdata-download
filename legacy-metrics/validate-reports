#!/usr/bin/env bash
#--------------------------------------------------------------------------------
# This script is used to validate the json report files which were generated
# directly by the generate-reports script in this same directory, and those which
# were generated by the fairdata-metrics report generation process. It expects
# there to be a subdirectory /reports containing the directly generated report
# files and a subdirectory /tmp/reports-production which either is a symbolic link
# to, or a copy of, the subdirectory /var/fairdata-metrics/reports.
#--------------------------------------------------------------------------------

SCRIPT="$(realpath $0)"
METRICS=`dirname "$SCRIPT"`
ROOT=`dirname "$METRICS"`

#--------------------------------------------------------------------------------

ENVIRONMENT="PRODUCTION"

START_DATE="2021-01"
MAX_DATE="2022-12"

echo "START_DATE: $START_DATE"
echo "MAX_DATE:   $MAX_DATE"

#--------------------------------------------------------------------------------

source $ROOT/venv/bin/activate

while [[ "$START_DATE" < "$MAX_DATE" ]]; do

    echo "$START_DATE"

    DIRPATH=`echo "$START_DATE" | sed -e 's/-/\//'`

    FILE_1="${METRICS}/reports/${START_DATE}-TotalDownloadsPerMonth.json"
    FILE_2="${METRICS}/tmp/reports-production/${DIRPATH}/${START_DATE}-DOWNLOAD-${ENVIRONMENT}-Total_Downloads_Per_Month.json"
    FILE_3="${METRICS}/reports/${START_DATE}-TotalDownloadsToDate.json"
    FILE_4="${METRICS}/tmp/reports-production/${DIRPATH}/${START_DATE}-DOWNLOAD-${ENVIRONMENT}-Total_Downloads_To_Date.json"

    START_DATE=`date -u -d "${START_DATE}-01 +1 month" +%Y-%m`

    if [ ! -f $FILE_1 ]; then
        echo "Missing $FILE_1"
    else
        if [ ! -f $FILE_2 ]; then
            echo "Missing $FILE_2"
        else
            echo "  Per Month"
            export FILE_1
            export FILE_2
            python $METRICS/lib/validate-reports.py
        fi
    fi

    if [ "$1" = "monthly" ]; then
        # validate monthly reports only
        continue
    fi

    FILE_1=$FILE_3
    FILE_2=$FILE_4

    if [ ! -f $FILE_1 ]; then
        echo "Missing $FILE_1"
    else
        if [ ! -f $FILE_2 ]; then
            echo "Missing $FILE_2"
        else
            echo "  To Date"
            export FILE_1
            export FILE_2
            python $METRICS/lib/validate-reports.py
        fi
    fi

done